<%- include('../layouts/header') %>

<!-- Portfolio Header -->
<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; position: relative; overflow: hidden;">
    <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
    
    <div style="display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2;">
        <div>
            <h1 style="margin: 0; font-size: 2em; display: flex; align-items: center;">
                <span style="margin-right: 15px;">üîî</span>
                Price Alerts: <%= portfolio.name %>
            </h1>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">Set up alerts to notify you when stocks reach target prices</p>
        </div>
        
        <div style="text-align: right;">
            <a href="/demo/portfolio/<%= portfolio._id %>" style="background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; text-decoration: none; border-radius: 20px; margin-right: 10px;">‚Üê Portfolio</a>
            <a href="/demo/dashboard" style="background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; text-decoration: none; border-radius: 20px; margin-right: 10px;">Dashboard</a>
            <a href="/demo/logout" style="background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; text-decoration: none; border-radius: 20px;">Logout</a>
        </div>
    </div>
</div>

<!-- Create New Alert Section -->
<div style="background: white; padding: 30px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
    <h3 style="margin: 0 0 20px 0; color: #2c3e50; display: flex; align-items: center;">
        <span style="margin-right: 10px;">‚ûï</span>
        Create New Alert
    </h3>
    
    <form id="alertForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">Stock Symbol</label>
            <input type="text" 
                   name="symbol" 
                   required 
                   placeholder="e.g., AAPL" 
                   style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; text-transform: uppercase;">
        </div>
        
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">Condition</label>
            <select name="condition" 
                    required 
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                <option value="GT">Greater Than (‚ñ≤)</option>
                <option value="LT">Less Than (‚ñº)</option>
            </select>
        </div>
        
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">Target Price</label>
            <input type="number" 
                   name="price" 
                   required 
                   min="0.01" 
                   step="0.01" 
                   placeholder="150.00" 
                   style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
        </div>
        
        <button type="submit" 
                style="background: linear-gradient(135deg, #FF9800, #F57C00); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1em;">
            üîî Create Alert
        </button>
    </form>
</div>

<!-- Alerts List -->
<div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
    <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 25px; border-bottom: 1px solid #e0e0e0;">
        <h3 style="margin: 0; color: #2c3e50; display: flex; align-items: center; justify-content: space-between;">
            <span>
                <span style="margin-right: 10px;">üìã</span>
                Your Alerts
                <span style="background: #2196F3; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8em; margin-left: 15px;">
                    <%= alerts.length %> active
                </span>
            </span>
        </h3>
    </div>

    <% if (alerts && alerts.length > 0) { %>
        <!-- Alerts Summary -->
        <div style="padding: 25px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;">
                <div style="text-align: center; background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Total Alerts</div>
                    <div style="font-size: 1.8em; font-weight: 700; color: #2c3e50;"><%= alerts.length %></div>
                </div>
                <div style="text-align: center; background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Active</div>
                    <div style="font-size: 1.8em; font-weight: 700; color: #4CAF50;">
                        <%= alerts.filter(a => !a.triggered).length %>
                    </div>
                </div>
                <div style="text-align: center; background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Triggered</div>
                    <div style="font-size: 1.8em; font-weight: 700; color: #FF9800;">
                        <%= alerts.filter(a => a.triggered).length %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Table -->
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 15px 20px; text-align: left; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #e0e0e0;">Symbol</th>
                        <th style="padding: 15px 20px; text-align: center; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #e0e0e0;">Condition</th>
                        <th style="padding: 15px 20px; text-align: right; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #e0e0e0;">Target Price</th>
                        <th style="padding: 15px 20px; text-align: center; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #e0e0e0;">Status</th>
                        <th style="padding: 15px 20px; text-align: left; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #e0e0e0;">Created</th>
                        <th style="padding: 15px 20px; text-align: center; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #e0e0e0;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% alerts.forEach((alert, index) => { %>
                        <tr style="<%= index % 2 === 0 ? 'background-color: #fafafa;' : 'background-color: white;' %> transition: background 0.2s;"
                            onmouseover="this.style.backgroundColor='#e3f2fd'" 
                            onmouseout="this.style.backgroundColor='<%= index % 2 === 0 ? '#fafafa' : 'white' %>'">
                            
                            <td style="padding: 15px 20px; border-bottom: 1px solid #e0e0e0;">
                                <strong style="font-size: 1.1em; color: #2196F3;"><%= alert.symbol %></strong>
                            </td>
                            
                            <td style="padding: 15px 20px; text-align: center; border-bottom: 1px solid #e0e0e0;">
                                <span style="
                                    padding: 6px 12px;
                                    border-radius: 20px;
                                    font-size: 0.9em;
                                    font-weight: bold;
                                    background-color: <%= alert.condition === 'GT' ? '#e8f5e9' : '#ffebee' %>;
                                    color: <%= alert.condition === 'GT' ? '#2e7d32' : '#c62828' %>;
                                ">
                                    <%= alert.condition === 'GT' ? '‚ñ≤ Above' : '‚ñº Below' %>
                                </span>
                            </td>
                            
                            <td style="padding: 15px 20px; text-align: right; border-bottom: 1px solid #e0e0e0;">
                                <strong style="font-size: 1.1em; color: #2c3e50;">$<%= alert.price.toFixed(2) %></strong>
                            </td>
                            
                            <td style="padding: 15px 20px; text-align: center; border-bottom: 1px solid #e0e0e0;">
                                <span style="
                                    padding: 6px 12px;
                                    border-radius: 12px;
                                    font-size: 0.85em;
                                    font-weight: bold;
                                    background-color: <%= alert.triggered ? '#fff3cd' : '#e8f5e9' %>;
                                    color: <%= alert.triggered ? '#856404' : '#2e7d32' %>;
                                ">
                                    <%= alert.triggered ? 'üîî TRIGGERED' : '‚è≥ ACTIVE' %>
                                </span>
                            </td>
                            
                            <td style="padding: 15px 20px; border-bottom: 1px solid #e0e0e0; color: #666;">
                                <%= alert.createdAt.toLocaleDateString() %>
                            </td>
                            
                            <td style="padding: 15px 20px; text-align: center; border-bottom: 1px solid #e0e0e0;">
                                <button onclick="deleteAlert('<%= alert._id %>')" 
                                        style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    üóëÔ∏è Delete
                                </button>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>

    <% } else { %>
        <!-- Empty State -->
        <div style="text-align: center; padding: 80px 40px;">
            <div style="font-size: 5em; margin-bottom: 20px; opacity: 0.3;">üîî</div>
            <h3 style="color: #2c3e50; margin-bottom: 15px;">No Alerts Set</h3>
            <p style="color: #666; margin-bottom: 30px; max-width: 500px; margin-left: auto; margin-right: auto; line-height: 1.6;">
                Create your first price alert to get notified when stocks reach your target prices. Stay informed and never miss an opportunity!
            </p>
        </div>
    <% } %>
</div>

<!-- How Alerts Work -->
<div style="background: white; padding: 30px; border-radius: 16px; margin-top: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
    <h3 style="margin: 0 0 20px 0; color: #2c3e50; display: flex; align-items: center;">
        <span style="margin-right: 10px;">üí°</span>
        How Price Alerts Work
    </h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px;">
        <div style="padding: 20px; background: #f8f9fa; border-radius: 12px; border-left: 4px solid #2196F3;">
            <h4 style="margin: 0 0 10px 0; color: #2c3e50;">1Ô∏è‚É£ Set Your Target</h4>
            <p style="margin: 0; color: #666; line-height: 1.6;">
                Choose a stock symbol and set your target price with a condition (above or below).
            </p>
        </div>
        
        <div style="padding: 20px; background: #f8f9fa; border-radius: 12px; border-left: 4px solid #4CAF50;">
            <h4 style="margin: 0 0 10px 0; color: #2c3e50;">2Ô∏è‚É£ Automatic Monitoring</h4>
            <p style="margin: 0; color: #666; line-height: 1.6;">
                Our system continuously monitors market prices and checks against your alert conditions.
            </p>
        </div>
        
        <div style="padding: 20px; background: #f8f9fa; border-radius: 12px; border-left: 4px solid #FF9800;">
            <h4 style="margin: 0 0 10px 0; color: #2c3e50;">3Ô∏è‚É£ Get Notified</h4>
            <p style="margin: 0; color: #666; line-height: 1.6;">
                When your target is reached, the alert is triggered and you can see it marked in your alerts list.
            </p>
        </div>
    </div>
</div>

<script>
// Auto-uppercase symbol input
document.querySelector('input[name="symbol"]').addEventListener('input', function() {
    this.value = this.value.toUpperCase();
});

// Create alert form submission
document.getElementById('alertForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        symbol: formData.get('symbol').toUpperCase(),
        condition: formData.get('condition'),
        price: parseFloat(formData.get('price'))
    };
    
    try {
        const response = await fetch('/api/alerts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('‚úÖ Alert created successfully!');
            window.location.reload();
        } else {
            const error = await response.json();
            alert('‚ùå Failed to create alert: ' + (error.error || 'Unknown error'));
        }
    } catch (error) {
        alert('‚ùå Network error: ' + error.message);
    }
});

// Delete alert
async function deleteAlert(alertId) {
    if (!confirm('Are you sure you want to delete this alert?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/alerts/${alertId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
            }
        });
        
        if (response.ok) {
            alert('‚úÖ Alert deleted successfully!');
            window.location.reload();
        } else {
            alert('‚ùå Failed to delete alert');
        }
    } catch (error) {
        alert('‚ùå Network error: ' + error.message);
    }
}

// Auto-refresh alerts every 30 seconds
setInterval(() => {
    console.log('Checking for triggered alerts...');
    // You could add silent background refresh here
}, 30000);
</script>

<%- include('../layouts/footer') %>